<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Node Charts - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
        }
        .back-btn {
            margin-bottom: 1rem;
        }
        .node-info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 2rem;
        }
        .fan-control {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background-color: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .toggle-switch.active {
            background-color: #28a745;
        }
        .toggle-switch.warning {
            background-color: #ffc107;
        }
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }
        .fan-label {
            font-weight: 500;
            min-width: 100px;
        }
        .fan-status {
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Thanh điều hướng -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-microchip me-2"></i>
                IoT System Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-list me-1"></i>
                    Back to Nodes
                </a>
            </div>
        </div>
    </nav>

    <!-- Nội dung chính -->
    <div class="container my-4">
        <!-- Nút quay lại -->
        <div class="back-btn d-flex justify-content-between">
            <a href="/" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                Back to Nodes List
            </a>
            <div class="d-flex flex-column gap-2">
                <!-- Điều khiển quạt -->
                <div class="d-flex gap-3">
                    <div class="fan-control">
                        <i class="fas fa-fan"></i>
                        <span class="fan-label">Manual Fan:</span>
                        <div class="toggle-switch" id="fanManualToggle">
                            <div class="toggle-slider"></div>
                        </div>
                        <span class="fan-status" id="fanManualStatus">OFF</span>
                    </div>
                    <div class="fan-control">
                        <i class="fas fa-magic"></i>
                        <span class="fan-label">Auto Fan:</span>
                        <div class="toggle-switch" id="fanAutoToggle">
                            <div class="toggle-slider"></div>
                        </div>
                        <span class="fan-status" id="fanAutoStatus">OFF</span>
                    </div>
                </div>
                <!-- Nút làm mới -->
                <div class="text-end">
                    <button id="refreshBtn" class="btn btn-primary" onclick="loadSensorData()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Thẻ thông tin Node -->
        <div class="card node-info-card" id="nodeInfoCard" style="display: none;">
            <div class="card-body">
                <h4 id="nodeTitle">Node Charts</h4>
                <p id="nodeDescription" class="mb-0">Real-time sensor data visualization</p>
            </div>
        </div>

    <!-- KPI cards -->
    <div id="kpiRow" class="row g-3 mb-3">
            <div class="col-sm-6 col-md-3">
                <div class="card text-white bg-danger">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small>Temp Max</small>
                                <div id="kpiTempMax" class="fs-5 fw-bold">--</div>
                            </div>
                            <i class="fas fa-thermometer-half fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small>Temp Min</small>
                                <div id="kpiTempMin" class="fs-5 fw-bold">--</div>
                            </div>
                            <i class="fas fa-temperature-low fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small>Hum Max</small>
                                <div id="kpiHumMax" class="fs-5 fw-bold">--</div>
                            </div>
                            <i class="fas fa-tint fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card text-white bg-secondary">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small>Hum Min</small>
                                <div id="kpiHumMin" class="fs-5 fw-bold">--</div>
                            </div>
                            <i class="fas fa-water fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <div id="kpiDebug" class="alert alert-secondary small" role="status" style="margin-top:6px;">
        KPI debug: initializing...
    </div>

        <!-- Container chứa biểu đồ -->
        <div id="chartsContainer">
            <div class="row">
                <!-- Biểu đồ nhiệt độ -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-thermometer-half me-2"></i>Temperature (°C)</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="temperatureChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Biểu đồ độ ẩm -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-tint me-2"></i>Humidity (%)</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="humidityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trạng thái đang tải -->
        <div id="loadingState" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading sensor data...</p>
        </div>

        <!-- Trạng thái không có dữ liệu -->
        <div id="noDataState" class="text-center py-5" style="display: none;">
            <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
            <h5 class="text-muted">No sensor data available</h5>
            <p class="text-muted">This node hasn't sent any sensor data yet</p>
        </div>
    </div>

    <!-- Thư viện Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const AI_SERVER_URL = "{{ ai_server_url }}";
        const selectedNode = "{{ selected_node }}";
        
        let charts = {};
        let updateInterval;

        // Trạng thái điều khiển quạt
        let fanState = {
            manual: false,
            auto: false
        };

        // Lấy trạng thái quạt từ localStorage
        function loadFanState() {
            const savedState = localStorage.getItem(`fanState_${selectedNode}`);
            if (savedState) {
                try {
                    fanState = JSON.parse(savedState);
                    console.log('Loaded fan state from localStorage:', fanState);
                    // Cập nhật UI theo trạng thái đã lưu
                    setFanUI('manual', fanState.manual);
                    setFanUI('auto', fanState.auto);
                } catch (e) {
                    console.error('Error loading fan state:', e);
                }
            }
        }

        // Lưu trạng thái quạt vào localStorage
        function saveFanState() {
            localStorage.setItem(`fanState_${selectedNode}`, JSON.stringify(fanState));
            console.log('Saved fan state to localStorage:', fanState);
        }

        // Lấy KPI đã lưu từ localStorage cho node hiện tại
        function loadSavedKPIs() {
            if (!selectedNode || selectedNode === 'None') return;
            try {
                const raw = localStorage.getItem(`kpis_${selectedNode}`);
                if (!raw) return;
                const k = JSON.parse(raw);
                if (!k) return;
                document.getElementById('kpiTempMax').textContent = k.temp_max != null ? `${k.temp_max} °C` : '--';
                document.getElementById('kpiTempMin').textContent = k.temp_min != null ? `${k.temp_min} °C` : '--';
                document.getElementById('kpiHumMax').textContent = k.hum_max != null ? `${k.hum_max} %` : '--';
                document.getElementById('kpiHumMin').textContent = k.hum_min != null ? `${k.hum_min} %` : '--';
                // Show KPI row (let Bootstrap manage layout) - use empty string to clear inline style
                document.getElementById('kpiRow').style.display = '';
                console.log('Loaded saved KPIs for', selectedNode, k);
                const dbg = document.getElementById('kpiDebug');
                if (dbg) dbg.textContent = `Loaded saved KPIs for ${selectedNode}: ${JSON.stringify(k)}`;
            } catch (e) {
                console.error('Error loading saved KPIs:', e);
                const dbg = document.getElementById('kpiDebug');
                if (dbg) dbg.textContent = `Error loading saved KPIs: ${e}`;
            }
        }

        // Lưu KPI vào localStorage cho node hiện tại
        function saveKPIs(kpiObj) {
            if (!selectedNode || selectedNode === 'None') return;
            try {
                // store numeric values (no units) and timestamp
                const doc = {
                    temp_max: kpiObj.temp_max != null ? Number(kpiObj.temp_max) : null,
                    temp_min: kpiObj.temp_min != null ? Number(kpiObj.temp_min) : null,
                    hum_max: kpiObj.hum_max != null ? Number(kpiObj.hum_max) : null,
                    hum_min: kpiObj.hum_min != null ? Number(kpiObj.hum_min) : null,
                    updated_at: Date.now()
                };
                localStorage.setItem(`kpis_${selectedNode}`, JSON.stringify(doc));
                console.log('Saved KPIs for', selectedNode, doc);
            } catch (e) {
                console.error('Error saving KPIs:', e);
            }
        }

        // Khởi tạo trang
        document.addEventListener('DOMContentLoaded', () => {
            if (selectedNode && selectedNode !== 'None') {
                updateNodeInfo();
                initializeCharts();
                loadFanState(); // Khôi phục trạng thái quạt
                loadSavedKPIs(); // Khôi phục KPI đã lưu nếu có
                loadSensorData();
                initializeFanControls();
                
                // Tự động làm mới mỗi 5 giây
                updateInterval = setInterval(loadSensorData, 5000);
            } else {
                showNoDataState();
            }
        });

        // Khởi tạo các nút bật/tắt quạt
        function initializeFanControls() {
            const manualToggle = document.getElementById('fanManualToggle');
            const autoToggle = document.getElementById('fanAutoToggle');
            
            manualToggle.addEventListener('click', () => {
                toggleFan('manual');
            });
            
            autoToggle.addEventListener('click', () => {
                toggleFan('auto');
            });
        }

        // Bật/tắt trạng thái quạt
        function toggleFan(type) {
            if (type === 'manual') {
                fanState.manual = !fanState.manual;
                updateFanUI('manual', fanState.manual);
            } else if (type === 'auto') {
                fanState.auto = !fanState.auto;
                updateFanUI('auto', fanState.auto);
            }
            
            // Lưu trạng thái vào localStorage
            saveFanState();
            
            console.log('Fan state:', fanState);
        }

        // Chỉ cập nhật giao diện quạt (không gọi API)
        function setFanUI(type, isActive) {
            const toggle = document.getElementById(`fan${type.charAt(0).toUpperCase() + type.slice(1)}Toggle`);
            const status = document.getElementById(`fan${type.charAt(0).toUpperCase() + type.slice(1)}Status`);

            if (isActive) {
                toggle.classList.add('active');
                if (type === 'manual') {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.add('warning');
                }
                status.textContent = 'ON';
                status.style.color = type === 'manual' ? '#28a745' : '#ffc107';
            } else {
                toggle.classList.remove('active', 'warning');
                status.textContent = 'OFF';
                status.style.color = '#666';
            }
        }

        // Cập nhật giao diện + gửi lệnh điều khiển quạt tới API
        async function updateFanUI(type, isActive) {
            // 1) Cập nhật UI ngay lập tức để phản hồi nhanh
            setFanUI(type, isActive);

            // 2) Trích xuất mac_id từ selectedNode (ví dụ: gateway1/node/test -> test)
            const macId = selectedNode ? selectedNode.split('/').pop() : 'unknown';

            // 3) Chuẩn bị payload lệnh
            const command = {
                type: 'fan_command',
                node_id: selectedNode,
                mac_id: macId,
                device: 'fan',
                mode: type,       // 'manual' | 'auto'
                active: isActive  // true | false
            };

            console.log('Sending fan command:', command);

            // 4) Gửi lệnh 1 lần duy nhất
            try {
                const res = await fetch('/cmd', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(command)
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok || (data?.status && data.status !== 'success')) {
                    throw new Error(`Failed response: ${res.status} ${res.statusText} ${JSON.stringify(data)}`);
                }

                console.log('Fan command acknowledged:', data);
            } catch (err) {
                console.error('Error sending fan command:', err);

                // Hoàn tác trạng thái UI nếu lỗi
                if (type === 'manual') {
                    fanState.manual = !isActive;
                    setFanUI('manual', fanState.manual);
                } else if (type === 'auto') {
                    fanState.auto = !isActive;
                    setFanUI('auto', fanState.auto);
                }
            }
        }


        // Cập nhật hiển thị thông tin node
        function updateNodeInfo() {
            const nodeInfoCard = document.getElementById('nodeInfoCard');
            const nodeTitle = document.getElementById('nodeTitle');
            const nodeDescription = document.getElementById('nodeDescription');
            
            nodeTitle.textContent = `Node: ${selectedNode}`;
            nodeDescription.textContent = `Real-time sensor data for ${selectedNode}`;
            nodeInfoCard.style.display = 'block';
        }

        // Khởi tạo biểu đồ nhiệt độ và độ ẩm
        function initializeCharts() {
            const chartConfigs = [
                { 
                    id: 'temperatureChart', 
                    label: 'Temperature (°C)', 
                    color: 'rgb(255, 99, 132)',
                    yAxisLabel: 'Temperature (°C)'
                },
                { 
                    id: 'humidityChart', 
                    label: 'Humidity (%)', 
                    color: 'rgb(54, 162, 235)',
                    yAxisLabel: 'Humidity (%)'
                }
            ];

            chartConfigs.forEach(config => {
                const ctx = document.getElementById(config.id).getContext('2d');
                charts[config.id] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: config.label,
                            data: [],
                            borderColor: config.color,
                            backgroundColor: config.color.replace('rgb', 'rgba').replace(')', ', 0.2)'),
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            x: {
                                display: true,
                                title: { 
                                    display: true, 
                                    text: 'Time',
                                    font: { size: 12, weight: 'bold' }
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            },
                            y: {
                                display: true,
                                title: { 
                                    display: true, 
                                    text: config.yAxisLabel,
                                    font: { size: 12, weight: 'bold' }
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            }
                        },
                        plugins: {
                            legend: { 
                                display: true, 
                                position: 'top',
                                labels: { font: { size: 11 } }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: 'white',
                                bodyColor: 'white'
                            }
                        }
                    }
                });
            });

            // Ẩn loading, hiển thị biểu đồ
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('chartsContainer').style.display = 'block';
        }

        // Tải dữ liệu cảm biến từ API
        async function loadSensorData() {
            if (!selectedNode || selectedNode === 'None') return;

            try {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] Loading data for node: ${selectedNode}`);
                
                // Thử lấy dữ liệu từ API server AI
                const response = await fetch(`/api/sensor-data/${selectedNode}?limit=30`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('API Response:', result);
                    
                    if (result.status === 'success' && result.data && result.data.length > 0) {
                        updateCharts(result.data);
                    } else {
                        console.log('No sensor data available');
                        showNoDataState();
                    }
                } else {
                    console.log('API request failed');
                    showNoDataState();
                }
            } catch (error) {
                console.error('Error loading sensor data:', error);
                showNoDataState();
            }
        }

        // Hiển thị trạng thái không có dữ liệu
        function showNoDataState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('chartsContainer').style.display = 'none';
            document.getElementById('noDataState').style.display = 'block';
        }

        // Cập nhật biểu đồ với dữ liệu mới
        function updateCharts(apiData) {
            console.log('Updating charts with data:', apiData);
            
            // Trích xuất mảng dữ liệu từ phản hồi API
            let sensorData = [];
            if (apiData && apiData.status === 'success' && apiData.data) {
                sensorData = apiData.data;
            } else if (Array.isArray(apiData)) {
                sensorData = apiData;
            }
            
            console.log('Processed sensor data:', sensorData);
            
            if (!sensorData || sensorData.length === 0) {
                console.log('No sensor data to display');
                showNoDataState();
                return;
            }

            // Hiển thị container biểu đồ
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('noDataState').style.display = 'none';
            document.getElementById('chartsContainer').style.display = 'block';
    // Hiển thị KPI row (let Bootstrap handle row display)
    document.getElementById('kpiRow').style.display = '';

            // Trích xuất nhãn thời gian từ dữ liệu (dùng trường 'time' hoặc chuyển đổi timestamp)
            const labels = sensorData.map(item => {
                if (item.time) {
                    return item.time;
                } else if (item.timestamp) {
                    return new Date(item.timestamp * 1000).toLocaleTimeString();
                } else {
                    return new Date().toLocaleTimeString();
                }
            });
            
            console.log('Time labels:', labels);
            
            // Cập nhật biểu đồ nhiệt độ
            if (charts.temperatureChart) {
                const tempData = sensorData.map(item => {
                    const temp = parseFloat(item.temperature);
                    return isNaN(temp) ? null : temp;
                });
                console.log('Temperature data:', tempData);
                
                charts.temperatureChart.data.labels = labels;
                charts.temperatureChart.data.datasets[0].data = tempData;
                charts.temperatureChart.update('none');
            }

            // Cập nhật KPI nhiệt độ
            let tMax = null, tMin = null, hMax = null, hMin = null;
            try {
                const temps = sensorData.map(item => parseFloat(item.temperature)).filter(v => !isNaN(v));
                if (temps.length > 0) {
                    tMax = Math.max(...temps).toFixed(1);
                    tMin = Math.min(...temps).toFixed(1);
                    document.getElementById('kpiTempMax').textContent = `${tMax} °C`;
                    document.getElementById('kpiTempMin').textContent = `${tMin} °C`;
                    console.log('KPI Temps set', {tMax, tMin});
                    const dbg = document.getElementById('kpiDebug');
                    if (dbg) dbg.textContent = `Computed KPIs for ${selectedNode} - temp_max:${tMax}, temp_min:${tMin}`;
                } else {
                    document.getElementById('kpiTempMax').textContent = '--';
                    document.getElementById('kpiTempMin').textContent = '--';
                    console.log('KPI Temps cleared');
                    const dbg = document.getElementById('kpiDebug');
                    if (dbg) dbg.textContent = `No temperature KPIs (no valid temp values)`;
                }
            } catch (e) { console.error('KPI temp error', e); }

            // Cập nhật biểu đồ độ ẩm
            if (charts.humidityChart) {
                const humData = sensorData.map(item => {
                    const hum = parseFloat(item.humidity);
                    return isNaN(hum) ? null : hum;
                });
                console.log('Humidity data:', humData);
                
                charts.humidityChart.data.labels = labels;
                charts.humidityChart.data.datasets[0].data = humData;
                charts.humidityChart.update('none');
            }

            // Cập nhật KPI độ ẩm
            try {
                const hums = sensorData.map(item => parseFloat(item.humidity)).filter(v => !isNaN(v));
                if (hums.length > 0) {
                    hMax = Math.max(...hums).toFixed(1);
                    hMin = Math.min(...hums).toFixed(1);
                    document.getElementById('kpiHumMax').textContent = `${hMax} %`;
                    document.getElementById('kpiHumMin').textContent = `${hMin} %`;
                    console.log('KPI Hums set', {hMax, hMin});
                    const dbg = document.getElementById('kpiDebug');
                    if (dbg) dbg.textContent += `; hum_max:${hMax}, hum_min:${hMin}`;
                } else {
                    document.getElementById('kpiHumMax').textContent = '--';
                    document.getElementById('kpiHumMin').textContent = '--';
                    console.log('KPI Hums cleared');
                    const dbg = document.getElementById('kpiDebug');
                    if (dbg) dbg.textContent += `; no humidity KPIs`;
                }
            } catch (e) { console.error('KPI hum error', e); }

            // Lưu KPI vào localStorage (nếu có giá trị hợp lệ)
            try {
                const kpiObj = {
                    temp_max: tMax !== null ? Number(tMax) : null,
                    temp_min: tMin !== null ? Number(tMin) : null,
                    hum_max: hMax !== null ? Number(hMax) : null,
                    hum_min: hMin !== null ? Number(hMin) : null
                };
                // Nếu có ít nhất một giá trị hợp lệ thì lưu
                if (kpiObj.temp_max !== null || kpiObj.temp_min !== null || kpiObj.hum_max !== null || kpiObj.hum_min !== null) {
                    saveKPIs(kpiObj);
                }
            } catch (e) {
                console.error('Error saving KPIs after compute:', e);
            }

            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] Charts updated successfully with ${sensorData.length} data points`);
        }

        // Dọn dẹp khi rời khỏi trang
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>